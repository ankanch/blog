<h1 id="图像中的字符定位与分割python实现">图像中的字符定位与分割（Python实现）</h1>

<h2 id="pre">pre</h2>

<p>假设我们有如下图像：</p>

<p>现在我们想要将图片中的数字一个一个分割出来。得到一系列的如下图象：</p>

<p>本文同时使用Python和C++实现了以上图像分割。</p>

<h2 id="灰度化图象">灰度化图象</h2>

<p>在处理之前，我们首先应该将图像去RGB，即在它对应的灰度图像上进行处理。我们可以使用opencv python库中的cvtColor函数来实现到灰度图像的转换。转换代码以及转换结果（归一化后）如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grayscaleimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">rawimg</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/ankanch/kanch.blog/master/images/pyimagesplit4.png" alt="grayscale_image" /></p>

<h2 id="归一化图象">归一化图象</h2>

<p>然后，我们需要对图片进行归一化，这样可以减少最后分割出的数字中的噪声：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grayscaleimg</span> <span class="o">=</span> <span class="n">grayscaleimg</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grayscaleimg</span><span class="p">))</span>
<span class="n">grayscaleimg</span><span class="p">[</span><span class="n">grayscaleimg</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<p>这里我们采取了对每个像素减去图像总像素的平均数，并设置阈值50以下的像素归零来实现归一化，归一化后的图像即上图所示。</p>

<h2 id="寻找分割边界">寻找分割边界</h2>

<p>接下来，我们需要确定分割边界，由于我们已经将背景的像素值归一化为0，我们只需要对图像分别从x方向（列扫描）和y方向（行扫描）进行扫描，统计每一行/列的0和非0值的个数即可。统计完毕绘图如下：</p>

<p>y方向上： <img src="https://raw.githubusercontent.com/ankanch/kanch.blog/master/images/pyimagesplit6.png" alt="histogram_on_row" /> x方向上： <img src="https://raw.githubusercontent.com/ankanch/kanch.blog/master/images/pyimagesplit5.png" alt="histogram_on_column" /></p>

<p>我们可以看到，行扫描结果让我们了解到了数字在y轴方向上的上下限，列扫描帮助我们了解到了每个数字之间的间隔位置（即值为0的地方，右图波谷）。在下图中，y方向那张图对应下图红色之间的部分，x方向图中的波谷（值为0的部分）对应下图中的橙色线段。</p>

<h2 id="开始分割">开始分割</h2>

<p>接下来，我们只需要将图像从y方向切割出来，再遍历x方向的所有临界点（即从非零值到零值，或者从零值到非零值的点），即可切分出字符。</p>

<ul>
  <li>
    <p>如果图像中的问题连着一起的怎么办？</p>

    <p><em>设定一定的阈值，当某列的非零值小于该阈值，则认为此列为黏带列，应该从这里分割。</em></p>
  </li>
</ul>

<h2 id="完整python代码">完整Python代码</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">rawimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"./test.jpg"</span><span class="p">)</span>
<span class="n">rawimg</span> <span class="o">=</span> <span class="n">rawimg</span> <span class="o">-</span> <span class="mi">246</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"raw image"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rawimg</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"grey scale image"</span><span class="p">)</span>
<span class="n">grayscaleimg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">rawimg</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grayscaleimg</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>

<span class="c1"># counting non-zero value by row , axis y
</span><span class="n">row_nz</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grayscaleimg</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">row_nz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">-</span> <span class="n">row</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"non-zero values on y (by row)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">row_nz</span><span class="p">)</span>

<span class="c1"># counting non-zero value by column, x axis
</span><span class="n">col_nz</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grayscaleimg</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="n">col_nz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">-</span> <span class="n">col</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"non-zero values on y (by col)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col_nz</span><span class="p">)</span>

<span class="c1">##### start split
# first find upper and lower boundary of y (row)
</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"y boudary deleted"</span><span class="p">)</span>
<span class="n">upper_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_nz</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">upper_y</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">break</span>
<span class="n">lower_y</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_nz</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">lower_y</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_nz</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span>
        <span class="k">break</span>
<span class="n">sliced_y_img</span> <span class="o">=</span> <span class="n">grayscaleimg</span><span class="p">[</span><span class="n">upper_y</span><span class="p">:</span><span class="n">lower_y</span><span class="p">,:]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sliced_y_img</span><span class="p">)</span>

<span class="c1"># then we find left and right boundary of every digital (x, on column)
</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"x boudary deleted"</span><span class="p">)</span>
<span class="n">column_boundary_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">record</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_nz</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">col_nz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col_nz</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">col_nz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col_nz</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">column_boundary_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">xl</span> <span class="o">=</span> <span class="p">[</span> <span class="n">column_boundary_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">column_boundary_list</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="p">]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xl</span><span class="p">:</span>
    <span class="n">img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">sliced_y_img</span><span class="p">[:,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
<span class="c1"># del invalid image
</span><span class="n">img_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="p">]</span>
<span class="c1"># show image
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_list</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="s">"./result/</span><span class="si">%</span><span class="s">s.jpg"</span><span class="o">%</span><span class="n">i</span><span class="p">,</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="c实现">C++实现</h2>

<p>同时，我也实现了C++版本（未使用任何矩阵库），Github地址：<a href="https://github.com/ankanch/image-processing-practice/blob/master/charsplit/C%2B%2B-implements/TextExtractor.h">https://github.com/ankanch/image-processing-practice/blob/master/charsplit/C%2B%2B-implements/TextExtractor.h</a></p>

